.PHONY: help start stop run test clean

# Default database configuration
DATABASE_URL ?= postgres://postgres:password@localhost:5418/rolekit_test?sslmode=disable

help: ## Show this help message
	@echo "RoleKit Sample Application"
	@echo ""
	@echo "Usage: make <target>"
	@echo ""
	@echo "Targets:"
	@echo "  help     Show this help message"
	@echo "  start    Start PostgreSQL 18 container"
	@echo "  stop     Stop PostgreSQL 18 container"
	@echo "  run      Run the sample application"
	@echo "  test     Run the sample application tests"
	@echo "  clean    Stop container and clean up"

start: ## Start PostgreSQL 18 container
	@echo "ðŸš€ Starting PostgreSQL 18..."
	podman compose up -d
	@echo "â³ Waiting for database to be ready..."
	@until podman exec rolekit-postgres-18 pg_isready -U postgres 2>/dev/null; do sleep 1; done
	@echo "âœ… PostgreSQL 18 is ready!"

stop: ## Stop PostgreSQL 18 container
	@echo "ðŸ›‘ Stopping PostgreSQL 18..."
	podman compose down
	@echo "âœ… PostgreSQL 18 stopped"

run: ## Run the sample application
	@echo "ðŸš€ Running RoleKit Sample Application..."
	DATABASE_URL=$(DATABASE_URL) go run .

test: ## Run the sample application with test database
	@echo "ðŸ§ª Testing RoleKit Sample Application..."
	DATABASE_URL=$(DATABASE_URL) go run .

clean: ## Stop container and clean up
	@echo "ðŸ§¹ Cleaning up..."
	podman compose down -v --remove-orphans
	@echo "âœ… Cleanup complete"

# Development targets
dev-setup: start ## Set up development environment
	@echo "ðŸ”§ Setting up development environment..."
	@echo "âœ… Development environment ready"

dev-run: ## Run in development mode
	@echo "ðŸ”§ Running in development mode..."
	DATABASE_URL=$(DATABASE_URL) go run .

dev-test: ## Test in development mode
	@echo "ðŸ§ª Testing in development mode..."
	DATABASE_URL=$(DATABASE_URL) go run .
